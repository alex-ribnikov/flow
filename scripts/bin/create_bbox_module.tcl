#!/bin/tclsh

proc _parse_args_ { args } {
    upvar opt opt
    set args [regsub -all "\{\|\}\|\\\\" $args ""]
    set split_args [split $args "-"]
    
    foreach arg $split_args {
        if { $arg == "" || $arg == "{" || $arg == "}" } { continue }
        set opt([lindex $arg 0]) [lrange $arg 1 end]
    }
}

proc create_bbox_module { args } {
    
    if { [regexp "\\\-help" $args] } { 
        puts "-HELP- Generate a verilog file with top module and empty instances.
        -module_name \tstring \tTop module name
        -block_list  \tlist   \tList of instance names and number of repetitions (rows,columns). i.e. \"u1 (2,2) u3 (2,2) u4 (1,2)\"  
        -file_name   \tstring \tOutput file name"
        return
    }
  
    ### Parse args ###
    _parse_args_  $args
    
    
    set module_name $opt(module_name)
    set block_list  $opt(block_list)
    set file_name $opt(file_name)
    
    
    ### Generate Instances ###
    set inst_list {}
    set prefix "i_$module_name"    
    array set inst_arr $block_list
    foreach inst [array names inst_arr] {

        set reps $inst_arr($inst)
        lassign [split [string range $reps 1 end-1] ","] rs cs

        for { set r 0 } { $r < $rs } { incr r } {
            for { set c 0 } { $c < $cs } { incr c } {
                set inst_name "${prefix}_r${r}_c${c}_i_$inst"
                lappend inst_list "$inst $inst_name ( );"
            }
        }
        
    }
    
    ### Create verilog file ###
    set fp [open $file_name w]

    puts $fp "/*
###############################################################
#  Generated by:      create_bbox_module script
#  Generated on:      [exec date]
#  Design:            $module_name
#  Block List:        $block_list
#  File Name:         $file_name
#  User:              $::env(USER)
###############################################################
*/\n\n"
    
    puts $fp "module $module_name ( );\n"
    
    foreach inst [lsort $inst_list] {
        puts $fp "\t$inst"
    }
    puts $fp "\nendmodule\n"
    close $fp    
    
}
create_bbox_module [split $argv " "]
